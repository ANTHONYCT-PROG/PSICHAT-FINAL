# üìÅ ESTRUCTURA DEL PROYECTO - PSICHAT V2 BACKEND

## üóÇÔ∏è Estructura General

```
backend/
‚îú‚îÄ‚îÄ üìÑ Archivos de Configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt          # Dependencias principales
‚îÇ   ‚îú‚îÄ‚îÄ requirements-dev.txt      # Dependencias de desarrollo
‚îÇ   ‚îú‚îÄ‚îÄ pytest.ini              # Configuraci√≥n de tests
‚îÇ   ‚îú‚îÄ‚îÄ env.example              # Variables de entorno de ejemplo
‚îÇ   ‚îî‚îÄ‚îÄ init_db.py               # Script de inicializaci√≥n de BD
‚îÇ
‚îú‚îÄ‚îÄ üìÅ app/                      # C√≥digo principal de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                  # Punto de entrada de FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py          # Inyecci√≥n de dependencias
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ api/                  # Capa de presentaci√≥n (API)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÅ routes/           # Endpoints de la API
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auth.py          # Autenticaci√≥n
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ chat.py          # Chat principal
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ analysis.py      # An√°lisis emocional
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tutor.py         # Funcionalidades de tutor
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tutor_chat.py    # Chat tutor-estudiante
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ websocket.py     # WebSocket handlers
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ reportes.py      # Generaci√≥n de reportes
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ core/                 # Configuraci√≥n y utilidades core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py            # Configuraci√≥n central
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py        # Excepciones personalizadas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logging.py           # Configuraci√≥n de logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ monitoring.py        # M√©tricas y monitoreo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.py          # Utilidades de seguridad
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ db/                   # Capa de persistencia
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py           # Configuraci√≥n de sesiones BD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py            # Modelos ORM
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crud.py              # Operaciones CRUD
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update_sesionchat_schema.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ models/               # Modelos de dominio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emotion.py           # Modelos de emociones
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ style.py             # Modelos de estilos
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ schemas/              # Esquemas Pydantic (DTOs)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py              # Esquemas de usuario
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.py              # Esquemas de chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analysis.py          # Esquemas de an√°lisis
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tutor.py             # Esquemas de tutor
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ message.py           # Esquemas de mensajes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reporte.py           # Esquemas de reportes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analysis_record.py   # Esquemas de registros de an√°lisis
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ services/             # L√≥gica de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat_service.py      # Servicio de chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analysis_service.py  # Servicio de an√°lisis
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tutor_service.py     # Servicio de tutor
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ websocket_service.py # Servicio WebSocket
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reporte_service.py   # Servicio de reportes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_service.py      # Servicio de usuarios
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ notifications/        # Sistema de notificaciones
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ alerts.py            # Alertas del sistema
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ utils/                # Utilidades generales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.py            # Utilidades de logging
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ text_processing.py   # Procesamiento de texto
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ types/                # Tipos personalizados
‚îÇ   ‚îî‚îÄ‚îÄ create_test_users.py     # Script para crear usuarios de prueba
‚îÇ
‚îú‚îÄ‚îÄ üìÅ migrations/               # Migraciones de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ env.py
‚îÇ   ‚îú‚îÄ‚îÄ README
‚îÇ   ‚îú‚îÄ‚îÄ script.py.mako
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ versions/             # Archivos de migraci√≥n
‚îÇ       ‚îî‚îÄ‚îÄ 004_add_reportes_table.py
‚îÇ
‚îú‚îÄ‚îÄ üìÅ ml_models/                # Modelos de Machine Learning
‚îÇ   ‚îú‚îÄ‚îÄ train_model.py           # Script de entrenamiento
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ emotion_detection/    # Modelos de detecci√≥n de emociones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dataset_emocion.csv
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emotion_model.joblib
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ train.py
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ style_classification/ # Modelos de clasificaci√≥n de estilos
‚îÇ       ‚îú‚îÄ‚îÄ dataset_estilo.csv
‚îÇ       ‚îú‚îÄ‚îÄ style_model.joblib
‚îÇ       ‚îî‚îÄ‚îÄ train.py
‚îÇ
‚îú‚îÄ‚îÄ üìÅ tests/                    # Tests automatizados
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py              # Configuraci√≥n de pytest
‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ test_analysis.py         # Tests de an√°lisis
‚îÇ   ‚îú‚îÄ‚îÄ test_auth.py             # Tests de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ test_chat.py             # Tests de chat
‚îÇ   ‚îú‚îÄ‚îÄ test_database.py         # Tests de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ test_integration.py      # Tests de integraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ test_main.py             # Tests del m√≥dulo principal
‚îÇ   ‚îú‚îÄ‚îÄ test_services.py         # Tests de servicios
‚îÇ   ‚îî‚îÄ‚îÄ test_tutor.py            # Tests de tutor
‚îÇ
‚îú‚îÄ‚îÄ üìÅ logs/                     # Archivos de log
‚îÇ   ‚îú‚îÄ‚îÄ access.log               # Logs de acceso
‚îÇ   ‚îú‚îÄ‚îÄ debug.log                # Logs de debug
‚îÇ   ‚îú‚îÄ‚îÄ debug.log.5              # Logs rotados
‚îÇ   ‚îú‚îÄ‚îÄ errors.log               # Logs de errores
‚îÇ   ‚îî‚îÄ‚îÄ performance.log          # Logs de rendimiento
‚îÇ
‚îú‚îÄ‚îÄ üìÅ uploads/                  # Archivos subidos por usuarios
‚îú‚îÄ‚îÄ üìÅ temp/                     # Archivos temporales
‚îú‚îÄ‚îÄ üìÑ psichat.db               # Base de datos SQLite (desarrollo)
‚îî‚îÄ‚îÄ üìÅ documentacion_backend/    # Documentaci√≥n del backend
```

## üîç An√°lisis Detallado por Capa

### üìÅ **Capa de Presentaci√≥n (`app/api/`)**

#### **Estructura de Routes**
```python
# app/api/routes/__init__.py
from . import auth, chat, analysis, tutor, tutor_chat, websocket, reportes

# Organizaci√≥n por funcionalidad
routes = {
    "auth": auth.router,           # Autenticaci√≥n y autorizaci√≥n
    "chat": chat.router,           # Chat principal con bot
    "analysis": analysis.router,   # An√°lisis emocional
    "tutor": tutor.router,         # Dashboard y herramientas de tutor
    "tutor_chat": tutor_chat.router, # Chat entre tutor y estudiante
    "websocket": websocket.router, # WebSocket para tiempo real
    "reportes": reportes.router    # Generaci√≥n de reportes
}
```

#### **Patr√≥n de Endpoints**
```python
# Ejemplo: app/api/routes/auth.py
@router.post("/login")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    """Endpoint de autenticaci√≥n"""
    pass

@router.post("/register")
async def register(user: UserCreate):
    """Endpoint de registro"""
    pass

@router.get("/me")
async def get_current_user_info(current_user: Usuario = Depends(get_current_user)):
    """Obtener informaci√≥n del usuario actual"""
    pass
```

### üìÅ **Capa de Aplicaci√≥n (`app/services/`)**

#### **Organizaci√≥n de Servicios**
```python
# app/services/chat_service.py
class ChatService:
    """Servicio principal de chat"""
    
    def __init__(self, db: Session):
        self.db = db
        self.analysis_service = AnalysisService(db)
        self.websocket_manager = WebSocketManager()
    
    async def send_message(self, user: Usuario, message: MessageCreate) -> Message:
        """Env√≠a un mensaje y procesa an√°lisis"""
        pass
    
    async def get_chat_history(self, user: Usuario, limit: int = 50) -> List[Message]:
        """Obtiene historial de chat"""
        pass
```

#### **Patr√≥n de Servicios**
- **Inyecci√≥n de dependencias**: Cada servicio recibe sus dependencias
- **Separaci√≥n de responsabilidades**: Un servicio por dominio
- **Async/await**: Para operaciones no bloqueantes
- **Manejo de errores**: Excepciones personalizadas

### üìÅ **Capa de Dominio (`app/db/models.py`)**

#### **Modelos de Entidad**
```python
# app/db/models.py
class Usuario(Base):
    """Entidad principal de usuario"""
    __tablename__ = "usuarios"
    
    # Campos principales
    id = Column(Integer, primary_key=True, index=True)
    email = Column(String(255), unique=True, index=True, nullable=False)
    nombre = Column(String(255), nullable=False)
    rol = Column(Enum(RolUsuario), default=RolUsuario.ESTUDIANTE)
    
    # Relaciones
    mensajes = relationship("Mensaje", back_populates="usuario")
    analisis = relationship("Analisis", back_populates="usuario")
    
    # √çndices para optimizaci√≥n
    __table_args__ = (
        Index('idx_usuario_email', 'email'),
        Index('idx_usuario_rol', 'rol'),
    )
```

#### **Relaciones entre Modelos**
```
Usuario (1) ‚Üê‚Üí (N) Mensaje
Mensaje (1) ‚Üê‚Üí (1) Analisis
Usuario (1) ‚Üê‚Üí (N) Alerta
Usuario (1) ‚Üê‚Üí (N) Intervencion
SesionChat (1) ‚Üê‚Üí (N) Mensaje
```

### üìÅ **Capa de Infraestructura**

#### **Configuraci√≥n (`app/core/`)**
```python
# app/core/config.py
class Settings(BaseSettings):
    """Configuraci√≥n centralizada"""
    
    # Configuraci√≥n de aplicaci√≥n
    APP_NAME: str = "PsiChat Backend"
    APP_VERSION: str = "2.0.0"
    DEBUG: bool = False
    ENVIRONMENT: str = "production"
    
    # Configuraci√≥n de base de datos
    DATABASE_URL: str = "sqlite:///./psichat.db"
    
    # Configuraci√≥n de seguridad
    SECRET_KEY: str = "your-secret-key-change-in-production"
    ALGORITHM: str = "HS256"
    
    # Configuraci√≥n de ML
    EMOTION_MODEL_PATH: str = "ml_models/emotion_detection/emotion_model.joblib"
    STYLE_MODEL_PATH: str = "ml_models/style_classification/style_model.joblib"
```

#### **Logging (`app/core/logging.py`)**
```python
# app/core/logging.py
import structlog

# Configuraci√≥n de logging estructurado
logger = structlog.get_logger()
performance_logger = structlog.get_logger("performance")

def setup_logging():
    """Configura el sistema de logging"""
    structlog.configure(
        processors=[
            structlog.stdlib.filter_by_level,
            structlog.stdlib.add_logger_name,
            structlog.stdlib.add_log_level,
            structlog.stdlib.PositionalArgumentsFormatter(),
            structlog.processors.TimeStamper(fmt="iso"),
            structlog.processors.StackInfoRenderer(),
            structlog.processors.format_exc_info,
            structlog.processors.UnicodeDecoder(),
            structlog.processors.JSONRenderer()
        ],
        context_class=dict,
        logger_factory=structlog.stdlib.LoggerFactory(),
        wrapper_class=structlog.stdlib.BoundLogger,
        cache_logger_on_first_use=True,
    )
```

## üîß Archivos de Configuraci√≥n

### **requirements.txt**
```txt
# Framework principal
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic>=2.5.0
pydantic-settings>=2.1.0

# Base de datos
sqlalchemy>=2.0.23
alembic>=1.13.1
psycopg2-binary>=2.9.9
redis>=5.0.1

# Autenticaci√≥n y seguridad
python-jose[cryptography]>=3.3.0
passlib[bcrypt]>=1.7.4
python-multipart>=0.0.6

# Machine Learning
scikit-learn>=1.3.2
joblib>=1.3.2
numpy>=1.24.3
pandas>=2.0.3
nltk>=3.8.1

# ... m√°s dependencias
```

### **pytest.ini**
```ini
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    -v
    --tb=short
    --strict-markers
    --disable-warnings
markers =
    unit: Unit tests
    integration: Integration tests
    slow: Slow running tests
```

### **env.example**
```bash
# Configuraci√≥n de la aplicaci√≥n
APP_NAME=PsiChat Backend
APP_VERSION=2.0.0
DEBUG=False
ENVIRONMENT=production

# Base de datos
DATABASE_URL=sqlite:///./psichat.db
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20

# Seguridad
SECRET_KEY=your-secret-key-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# Gemini AI
GEMINI_API_KEY=your-gemini-api-key
GEMINI_API_BASE_URL=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent

# ... m√°s variables
```

## üß™ Estructura de Tests

### **Organizaci√≥n de Tests**
```python
# tests/conftest.py
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

@pytest.fixture
def client():
    """Cliente de prueba para FastAPI"""
    from app.main import app
    return TestClient(app)

@pytest.fixture
def db_session():
    """Sesi√≥n de base de datos para tests"""
    engine = create_engine("sqlite:///./test.db")
    TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = TestingSessionLocal()
    yield session
    session.close()
```

### **Tipos de Tests**
- **Unit Tests**: Pruebas de funciones individuales
- **Integration Tests**: Pruebas de integraci√≥n entre componentes
- **API Tests**: Pruebas de endpoints HTTP
- **Database Tests**: Pruebas de operaciones de base de datos

## üìä Estructura de Logs

### **Tipos de Logs**
```
logs/
‚îú‚îÄ‚îÄ access.log       # Logs de acceso HTTP
‚îú‚îÄ‚îÄ debug.log        # Logs de debug y desarrollo
‚îú‚îÄ‚îÄ errors.log       # Logs de errores y excepciones
‚îú‚îÄ‚îÄ performance.log  # Logs de rendimiento
‚îî‚îÄ‚îÄ debug.log.5      # Logs rotados (m√°ximo 5 archivos)
```

### **Configuraci√≥n de Rotaci√≥n**
```python
# Rotaci√≥n autom√°tica de logs
LOG_MAX_SIZE = 10 * 1024 * 1024  # 10MB
LOG_BACKUP_COUNT = 5              # Mantener 5 archivos de backup
```

## üîÑ Migraciones de Base de Datos

### **Estructura de Migraciones**
```python
# migrations/versions/004_add_reportes_table.py
"""Add reportes table

Revision ID: 004
Revises: 003
Create Date: 2024-07-13 19:22:00.000000

"""
from alembic import op
import sqlalchemy as sa

def upgrade():
    """Crear tabla de reportes"""
    op.create_table(
        'reportes',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('sesion_id', sa.Integer(), nullable=False),
        sa.Column('tutor_id', sa.Integer(), nullable=False),
        # ... m√°s columnas
        sa.PrimaryKeyConstraint('id')
    )

def downgrade():
    """Eliminar tabla de reportes"""
    op.drop_table('reportes')
```

## üß† Modelos de Machine Learning

### **Estructura de Modelos**
```
ml_models/
‚îú‚îÄ‚îÄ train_model.py                    # Script principal de entrenamiento
‚îú‚îÄ‚îÄ emotion_detection/                # Modelos de emociones
‚îÇ   ‚îú‚îÄ‚îÄ dataset_emocion.csv          # Dataset de entrenamiento
‚îÇ   ‚îú‚îÄ‚îÄ emotion_model.joblib         # Modelo entrenado
‚îÇ   ‚îî‚îÄ‚îÄ train.py                     # Script de entrenamiento espec√≠fico
‚îî‚îÄ‚îÄ style_classification/             # Modelos de estilos
    ‚îú‚îÄ‚îÄ dataset_estilo.csv           # Dataset de entrenamiento
    ‚îú‚îÄ‚îÄ style_model.joblib           # Modelo entrenado
    ‚îî‚îÄ‚îÄ train.py                     # Script de entrenamiento espec√≠fico
```

## üìù Convenciones de Nomenclatura

### **Archivos y Carpetas**
- **snake_case**: Para archivos Python (`chat_service.py`)
- **kebab-case**: Para carpetas (`ml-models/`)
- **PascalCase**: Para clases (`ChatService`)
- **camelCase**: Para variables y funciones (`sendMessage`)

### **Base de Datos**
- **snake_case**: Para tablas y columnas (`usuarios`, `fecha_creacion`)
- **PascalCase**: Para modelos ORM (`Usuario`, `Mensaje`)
- **UPPER_CASE**: Para constantes (`RolUsuario.ESTUDIANTE`)

### **API Endpoints**
- **kebab-case**: Para rutas (`/api/v1/chat-messages`)
- **snake_case**: Para par√°metros (`user_id`, `message_text`)

## üîí Consideraciones de Seguridad

### **Archivos Sensibles**
- `.env`: Variables de entorno (no versionado)
- `psichat.db`: Base de datos (no versionado en producci√≥n)
- `*.joblib`: Modelos ML (pueden ser grandes)
- `logs/`: Archivos de log (no versionados)

### **Archivos de Configuraci√≥n**
- `requirements.txt`: Dependencias (versionado)
- `pytest.ini`: Configuraci√≥n de tests (versionado)
- `env.example`: Ejemplo de variables (versionado)

---

**Versi√≥n**: 2.0.0  
**√öltima actualizaci√≥n**: Julio 2024  
**Organizaci√≥n**: Arquitectura en capas con separaci√≥n de responsabilidades 